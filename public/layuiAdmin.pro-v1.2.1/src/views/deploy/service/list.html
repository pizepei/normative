<title>项目列表</title>
<div class="layui-card layadmin-header">
    <div class="layui-breadcrumb" lay-filter="breadcrumb">
        <a lay-href="">主页</a>
        <a><cite>项目部署</cite></a>
        <a><cite>主机管理</cite></a>
        <a><cite>分组管理</cite></a>
    </div>
</div>

<div class="layui-fluid">
    <div class="layui-row layui-col-space15">
        <div class="layui-col-md12">
            <div class="layui-card">
                <div class="layui-card-header">群组</div>
                <div class="layui-card-body">

                    <form class="layui-form" lay-filter="component-form-host-group">

                        <div class="layui-form-item">
                            <div class="layui-inline">
                                <label class="layui-form-label">群组</label>
                                <div class="layui-input-inline">
                                    <script type="text/html" template lay-url="/deploy/server/group-list.json" lay-done="layui.data.done(d);">
                                        <select name="modules" lay-verify="required" lay-search=""  lay-filter="deploy-server-groups-list">
                                            <option value="00000000-0000-0000-0000-000000000000" selected >未分组主机</option>
                                            {{#  layui.each(d.data.list, function(index, item){ }}
                                            <li>
                                                <option value="{{item.id}}">{{item.name}}</option>
                                            </li>
                                            {{#  }); }}
                                        </select>

                                    </script>

                                </div>
                            </div>
                        </div>
                    </form>


                </div>
            </div>

            <div class="layui-card">
                <div class="layui-card-header">分组列表</div>
                <div class="layui-card-header"><button type="button" class="layui-btn layui-btn-sm layui-btn-normal" lay-tips="添加一个分组" lay-offset="5" data-type="add"><i class="layui-icon"></i> 添加</button></div>

                <div class="layui-card-body">

                    <table class="layui-hide" id="deploy-host-list-table-resetPage"  lay-filter="table"></table>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    //群组列表
    layui.data.done = function(d){
        layui.use(['form'], function(){
            var form = layui.form;
            form.render(null, 'component-form-host-group');//渲染该模板下的动态表单
        });
    };

    layui.use(['admin', 'table','laytpl','laydate'], function(){
        var admin = layui.admin
            ,form = layui.form
            ,table = layui.table
            ,laytpl = layui.laytpl
            ,laydate = layui.laydate
            ,$ = layui.$;
        // getHost();
        //选择群组
        form.on('select(deploy-server-groups-list)', function(data){
            getHost(data.value);
            table.reload('deploy-host-list-table-resetPage')
        });

        //点击添加
        form.on('submit(component-form-element-host-add)', function(data){
            admin.req({
                url: '/deploy/server/host.json' //实际使用请改成服务端真实接口
                ,type:'post'
                ,data: data.field
                ,done: function(res){
                    //登入成功的提示与跳转
                    layer.msg(res.msg, {
                        offset: '15px'
                        ,icon: 1
                        ,time: 1000
                    }, function(){
                        layer.closeAll('page');
                        getHost();
                        table.reload('deploy-host-list-table-resetPage')

                    });
                }
            });
            return false;
        });
        //点击添加编辑
        form.on('submit(component-form-element-host-edit)', function(data){
            console.log(data)
            admin.req({
                url: '/deploy/server/host/'+data.field.id+'.json' //实际使用请改成服务端真实接口
                ,type:'put'
                ,data: data.field
                ,done: function(res){
                    //登入成功的提示与跳转
                    layer.msg(res.msg, {
                        offset: '15px'
                        ,icon: 1
                        ,time: 1000
                    }, function(){
                        layer.closeAll('page');
                        table.reload('deploy-host-list-table-resetPage')
                    });
                }
            });
            return false;
        });

        // 添加操作
        $('.layui-card-header .layui-btn').on('click', function(){
            setTpl({
                'id':'',
                'name':'',
                'serve_group':'',
                'explain':'',
                'status':'',
                'group_id':'',
                'server_ip':'',
                'ssh2_port':'',
                'ssh2_user':'',
                'ssh2_auth':'',
                'ssh2_pubkey':'',
                'ssh2_prikey':'',
                'ssh2_password':'',
                'hardware':'',
                'os':'',
                'os_versions':'',
                'os_versions_number':'',
                'operation':'',
                'period':'2019-08-25',
                'bt_api':'',
            });
        });
        // 初始化 编辑 添加 分组
        function setTpl(data){
            laytpl($('#deploy-group-info').html()).render(data, function(html){
                layer.open({
                    type: 1,
                    skin: 'layui-layer-rim',
                    area: ['900px', '840px'],
                    content: html
                });
                laydate.render({
                    elem: '#deploy-host-period' //指定元素
                });
                form.render();//渲染动态表单
            });
        }
        // 获取分组列表
        function getHost(group_id = '00000000-0000-0000-0000-000000000000')
        {
            table.render({
                elem: '#deploy-host-list-table-resetPage'
                ,url: '/deploy/server/Config-list/'+group_id+'.json'
                ,type:'get'
                ,response: {
                    statusCode: 200 //规定成功的状态码，默认：0
                }
                ,parseData: function(res){ //res 即为原始返回的数据
                    return {
                        "code": res.code, //解析接口状态
                        "msg": res.msg, //解析提示文本
                        "count": res.data.total, //解析数据长度
                        "data": res.data.list //解析数据列表
                    };
                }
                // ,cellMinWidth: 90 //全局定义常规单元格的最小宽度，layui 2.2.1 新增
                ,cols: [[
                    ,{field:'name', title: '名称', sort: true, fixed: 'left'}
                    ,{field:'server_ip', title: 'IP'}
                    ,{field:'ssh2_port', title: 'port'}
                    ,{field:'os', title: 'OS',templet: function(d){
                            return d.os+'['+d.os_versions+']'
                        }}
                    ,{field:'status',  title: '状态',templet: function(d){
                            if (d.status == 1) return '停用';
                            if (d.status == 2) return '正常';
                            if (d.status == 3) return '维护';
                            if (d.status == 4) return '等待';
                            if (d.status == 5) return '异常';
                        }}
                    ,{field:'serve_group',  title: '环境',templet: function(d){
                            if (d.serve_group == 'develop') return '开发';
                            if (d.serve_group == 'production') return '生产';
                            if (d.serve_group == 'developTest') return '开发测试';
                            if (d.serve_group == 'productionTest') return '生产测试';
                        }}
                    ,{  title: '操作' , align:'center', toolbar: '#deploy-host-list-table-toolbar'}
                ]]
            });
        }
        // 编辑 更新
        function edit(data)
        {
            setTpl(data);
        }

        function del(data)
        {
            admin.req({
                url: '/deploy/server/host/'+data.id+'.json' //实际使用请改成服务端真实接口
                ,type:'delete'
                ,done: function(res){
                    //登入成功的提示与跳转
                    layer.msg(res.msg, {
                        offset: '15px'
                        ,icon: 1
                        ,time: 1000
                    }, function(){
                        layer.closeAll('page');
                        getHost();
                    });
                }
            });
        }
        table.on('tool(table)', function(obj){ //注：tool是工具条事件名，test是table原始容器的属性 lay-filter="对应的值"
            var data = obj.data; //获得当前行数据
            var layEvent = obj.event; //获得 lay-event 对应的值（也可以是表头的 event 参数对应的值）
            var tr = obj.tr; //获得当前行 tr 的DOM对象
            if(layEvent === 'del'){ //删除
                layer.confirm('真的删除行么', function(index){
                    del(data);
                    obj.del(); //删除对应行（tr）的DOM结构，并更新缓存
                    layer.close(index);
                    //向服务端发送删除指令
                });
            } else if(layEvent === 'edit'){ //编辑
                edit(data);
            } else {

            }
        });

    });
</script>
<script type="text/html" id="deploy-host-list-table-toolbar">
    <a class="layui-btn layui-btn-xs" lay-event="edit">编辑</a>
    <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>
</script>
<script id="deploy-group-info" type="text/html">

    <div class="layui-card">
        <div class="layui-card-header">添加分组</div>
        <div class="layui-card-body">
            <form class="layui-form"  lay-filter="component-form-element">
                {{# if(d.id !==''){ }}
                <input type="hidden" name="id" lay-verify="required" placeholder="" autocomplete="off" class="layui-input" value={{d.id}}>
                {{# } }}
                <div class="layui-row layui-col-space10 layui-form-item">
                    <div class="layui-col-lg5">
                        <label class="layui-form-label">名称：</label>
                        <div class="layui-input-block">
                            <input type="text" name="name" lay-verify="required" placeholder="" autocomplete="off" class="layui-input" value={{d.name}}>
                        </div>
                    </div>
                    <div class="layui-col-lg5">
                        <label class="layui-form-label">备注：</label>
                        <div class="layui-input-block">
                            <input type="text" name="explain" lay-verify="required" placeholder="" autocomplete="off" class="layui-input" value={{d.explain}}>
                        </div>
                    </div>


                    <div class="layui-col-lg5">
                        <label class="layui-form-label">IP：</label>
                        <div class="layui-input-block">
                            <input type="text" name="server_ip" lay-verify="required" placeholder="" autocomplete="off" class="layui-input" value={{d.server_ip}}>
                        </div>
                    </div>

                    <div class="layui-col-lg5">
                        <label class="layui-form-label">端口：</label>
                        <div class="layui-input-block">
                            <input type="text" name="ssh2_port" lay-verify="required" placeholder="" autocomplete="off" class="layui-input" value={{d.ssh2_port}}>
                        </div>
                    </div>
                    <div class="layui-col-lg5">
                        <label class="layui-form-label">账号：</label>
                        <div class="layui-input-block">
                            <input type="text" name="ssh2_user" lay-verify="required" placeholder="" autocomplete="off" class="layui-input" value={{d.ssh2_user}}>
                        </div>
                    </div>

                    <div class="layui-col-lg5">
                        <label class="layui-form-label">主机密码：</label>
                        <div class="layui-input-block">
                            <input type="password" class="layui-input"name="ssh2_password"  value={{d.ssh2_password}}>
                        </div>
                    </div>
                    <div class="layui-col-lg5">
                        <label class="layui-form-label">系统：</label>
                        <div class="layui-input-block">
                            <select name="os" lay-verify="">
                                <option value="Linux"{{# if(d.os == 'Linux'){ }}selected{{# } }}>Linux</option>
                                <option value="Windows" {{# if(d.os == 'Windows'){ }}selected{{# } }}>Windows</option>
                            </select>
                        </div>
                    </div>

                    <div class="layui-col-lg5">
                        <label class="layui-form-label">系统版本：</label>
                        <div class="layui-input-block">
                            <input type="text" name="os_versions" lay-verify="required" placeholder="" autocomplete="off" class="layui-input" value={{d.os_versions}}>
                        </div>
                    </div>

                    <div class="layui-col-lg5">
                        <label class="layui-form-label">WEB环境：</label>
                        <div class="layui-input-block">

                            <select name="operation" lay-verify="">
                                <option value="bt"{{# if(d.os == 'bt'){ }}selected{{# } }}>bt</option>
                                <option value="lnmp" {{# if(d.os == 'lnmp'){ }}selected{{# } }}>lnmp</option>
                            </select>
                        </div>
                    </div>


                    <div class="layui-col-lg5">
                        <label class="layui-form-label">主机期限：</label>
                        <div class="layui-input-block">
                            <input type="text" class="layui-input"name="period" id="deploy-host-period" value={{d.period}}>
                        </div>
                    </div>


                    <div class="layui-col-lg5">
                        <label class="layui-form-label">验证方式：</label>
                        <div class="layui-input-block">
                            <select name="ssh2_auth" lay-verify="">
                                <option value="password"{{# if(d.ssh2_auth == 'password'){ }}selected{{# } }}>password</option>
                                <option value="pubkey" {{# if(d.ssh2_auth == 'pubkey'){ }}selected{{# } }}>pubkey</option>
                            </select>
                        </div>
                    </div>
                    {{# if(d.id !==''){}}
                    <div class="layui-col-lg5">
                        <label class="layui-form-label">选择分组：</label>
                        <div class="layui-input-block">
                            <input type="text" name="group" lay-verify="required" placeholder="" autocomplete="off" class="layui-input" value={{d.os_versions}}>
                        </div>
                    </div>
                    {{#}}}



                </div>


                <div class="layui-row layui-col-space10 layui-form-item">
                    <div class="layui-col-lg5">
                        <label class="layui-form-label">pubkey：</label>
                        <div class="layui-input-block">
                            <textarea name="ssh2_pubkey" placeholder="这里的公钥对不是必须为当前用户的"   class="layui-textarea">{{d.ssh2_pubkey}}</textarea>
                        </div>
                    </div>
                    <div class="layui-col-lg5">
                        <label class="layui-form-label">prikey：</label>
                        <div class="layui-input-block">
                            <textarea name="ssh2_prikey" placeholder="私钥"  class="layui-textarea">{{d.ssh2_prikey}}</textarea>
                        </div>
                    </div>
                </div>



                <div class="layui-form-item">
                    <label class="layui-form-label">环境类型：</label>
                    <div class="layui-input-block">
                        <input type="radio" name="serve_group" value="develop" title="开发" {{# if(d.serve_group == 'develop' || d.serve_group == ''){ }}checked{{# } }}>
                        <input type="radio" name="serve_group" value="developTest" title="开发测试" {{# if(d.serve_group == 'developTest' ){ }}checked{{# } }} >
                        <input type="radio" name="serve_group" value="production" title="生产"   {{# if(d.serve_group == 'production' ){ }}checked{{# } }} >
                        <input type="radio" name="serve_group" value="productionTest" title="生产测试"  {{# if(d.serve_group == 'productionTest' ){ }}checked{{# } }} >
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">状态：</label>
                    <div class="layui-input-block">
                        <input type="radio" name="status" value="1" title="停用" {{# if(d.status == 1){ }}checked{{# } }}>
                        <input type="radio" name="status" value="2" title="正常" {{# if(d.status == 2){ }}checked{{# } }}>
                        <input type="radio" name="status" value="3" title="维护" {{# if(d.status == 3){ }}checked{{# } }}>
                        <input type="radio" name="status" value="4" title="等待" {{# if(d.status == 4 || d.status == '' ){ }}checked{{# } }}>
                        <input type="radio" name="status" value="5" title="异常" {{# if(d.status == 5){ }}checked{{# } }}>
                    </div>
                </div>

                <div class="layui-form-item">
                    <div class="layui-input-block">
                        {{#  if(d.id ==''){ }}
                        <button class="layui-btn" lay-submit lay-filter="component-form-element-host-add">确认添加</button>
                        {{# }else{ }}
                        <button class="layui-btn" lay-submit lay-filter="component-form-element-host-edit">确认修改</button>
                        {{# } }}

                    </div>
                </div>
            </form>
        </div>
    </div>

</script>
